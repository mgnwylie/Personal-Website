---
title: "Inequality Map"
author: "Megan Wylie"
date: '2019-10-02'
categories: ["R"]
tags: ["R Markdown", "plot", "regression"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Income inequality and health research

I wrote my Master's thesis on the topic of income inequality and health in Canadian cities. To show inequality throughout Canada, I mapped inequality levels for each Canadian city for three time periods: 2001, 2006, and 2011.

Here is a reproduction of that map, which now includes 2016.

# Map

```{r setup, fig.caption = 'Urban Inequality in Canada', include=FALSE}

#install packages

#install.packages("geojsonio")
#install.packages("sf")
#install.packages("mapview")
#install.packages("tidyverse")
#install.packages("shiny")
install.packages("mlogit")

#load the packages

library(tidyverse)
library(geojsonio)
library(sf)
library(mapview)
library(leaflet)
library(shiny)

# Here I set up the Canada map from the map package
mapStates = map(regions=sov.expand("Canada"), fill = TRUE, plot = FALSE) 

## Uploading Geojson file to R when file has NULL columns

#upload data
df <- geojsonio::geojson_read("data/data.geojson")

#isolate the important stuff
df<- df$features

#rename columns for later
new.names <- c(
  "type" ,
  names(df[[1]]$properties) ,
  "geometry.type" ,
  "lng" ,
  "lat"
)

#Start creating datafram
point.locations <- df[[1]] %>% as.data.frame()

#Rename columns with your new names
names(point.locations) <- new.names

#Loop through every item in the geojson list
for (i in 2:length(df)) {
  
  t <- df[[i]]$properties %>% unlist()
  
  #Make sure the item doesn't have any null column values
  if (length(t) == 12) {
    
    out.file <- df[[i]] %>% as.data.frame()
    names(out.file) <- new.names
    
    point.locations <- dplyr::bind_rows(point.locations , out.file)
    
  } else {
    message(paste(t[["CMANAME"]] , "has NULL values."))
  }

}

#Make data frame a spatial dataframe ("simple feature")
point.locations.sf <- st_as_sf(point.locations , coords = c("lng" , "lat") , crs = 3347)

#Put it on a map!

# Name cities
mapview::mapview(point.locations.sf, label = point.locations.sf$CMANAME)

point.locations.sf.transform <- sf::st_transform(point.locations.sf , 4326)

# map via leaflet
leaflet(point.locations.sf.transform) %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>%
  #addCircleMarkers defines size in terms of metres - they're too similar in size
  addCircleMarkers(radius = 50*(qlogis(point.locations.sf.transform$gini01)),
                   color = "#3182bd" ,
                   fillColor = "#9ecae1" ,
                   fillOpacity = .6 ,
                   weight = 2 ,
                   label = ~CMANAME)



```



